---
layout: post
title: Python virtualenv и spark-submit
---

Сегодня решал одну проблему, когда zip архив с python virtualenv раскидывался через spark-submit на кластер hadoop и при этом python не запускался и падал с ошибкой:  
<code>symbol lookup error: ./bin/python3.6: undefined symbol: _Py_LegacyLocaleDetected</code>

-----

Сборка происходила в docker контейнере, стал проверять локально, пакую в zip, распаковываю там же - работает, но на части серверов кластера ошибка. Обращаю внимание, что python3.6 файл бинарный, а не симлинк. Добавляю ключ <code>zip -y</code> чтобы не тащить копии файлов по симлинкам и python3.6 ссылался бы на системный python на кластере, проверяю, везде все работает.  
Делаем тест через spark-submit, но пошли новые ошибки с таймаутом...  
Проверяю руками на кластере и вижу, что бинарный файл python3.6 это не симлинк, а обычный файл в котором сожержится просто ссылка из симлинка, при тестовом запуске руками <code>python3.6 -V</code> выдает версию, но при этом переходит в интерактивный режим...  
Получается, что <code>spark-submit --archive < archive ></code> криво распаковывает zip архивы. Поменяли на tar.gz и все стало отлично работать везде!

-----

Вывод: не стоит пользоваться zip, он плохо работает с файловой системой unix-like систем...  
Пользуйтесь tar'ом!
